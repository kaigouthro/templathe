# WeChat

There is not yet a straightforward way to export personal WeChat messages. However if you just need no more than few hundreds of messages for model fine-tuning or few-shot examples, this notebook shows how to create your own chat loader that works on copy-pasted WeChat messages to a list of LangChain messages.

Highly inspired by <https://python.langchain.com/docs/integrations/chat_loaders/discord>

The process has five steps:

1. Open your chat in the WeChat desktop app. Select messages you need by mouse-dragging or right-click. Due to restrictions, you can select up to 100 messages once a time. `CMD`/`Ctrl` + `C` to copy.

1. Create the chat .txt file by pasting selected messages in a file on your local computer.

1. Copy the chat loader definition from below to a local file.

1. Initialize the `WeChatChatLoader` with the file path pointed to the text file.

1. Call `loader.load()` (or `loader.lazy_load()`) to perform the conversion.

1. Create message dump[​](#1-create-message-dump "Direct link to 1. Create message dump")

______________________________________________________________________

This loader only supports .txt files in the format generated by copying messages in the app to your clipboard and pasting in a file. Below is an example.

```txt
女朋友 2023/09/16 2:51 PM  
天气有点凉  
  
男朋友 2023/09/16 2:51 PM  
珍簟凉风著，瑶琴寄恨生。嵇君懒书札，底物慰秋情。  
  
女朋友 2023/09/16 3:06 PM  
忙什么呢  
  
男朋友 2023/09/16 3:06 PM  
今天只干成了一件像样的事  
那就是想你  
  
女朋友 2023/09/16 3:06 PM  
[动画表情]  

```

2. Define chat loader[​](#2-define-chat-loader "Direct link to 2. Define chat loader")

______________________________________________________________________

LangChain currently does not support

```python
import logging  
import re  
from typing import Iterator, List  
  
from langchain.schema import HumanMessage, BaseMessage  
from langchain.chat\_loaders import base as chat\_loaders  
  
logger = logging.getLogger()  
  
  
class WeChatChatLoader(chat\_loaders.BaseChatLoader):  
   
 def \_\_init\_\_(self, path: str):  
 """  
 Initialize the Discord chat loader.  
  
 Args:  
 path: Path to the exported Discord chat text file.  
 """  
 self.path = path  
 self.\_message\_line\_regex = re.compile(  
 r"(?P<sender>.+?) (?P<timestamp>\d{4}/\d{2}/\d{2} \d{1,2}:\d{2} (?:AM|PM))", # noqa  
 # flags=re.DOTALL,  
 )  
  
 def \_append\_message\_to\_results(  
 self,  
 results: List,  
 current\_sender: str,  
 current\_timestamp: str,  
 current\_content: List[str],  
 ):  
 content = "\n".join(current\_content).strip()  
 # skip non-text messages like stickers, images, etc.  
 if not re.match(r"\[.\*\]", content):  
 results.append(  
 HumanMessage(  
 content=content,  
 additional\_kwargs={  
 "sender": current\_sender,  
 "events": [{"message\_time": current\_timestamp}],  
 },  
 )  
 )  
 return results  
  
 def \_load\_single\_chat\_session\_from\_txt(  
 self, file\_path: str  
 ) -> chat\_loaders.ChatSession:  
 """  
 Load a single chat session from a text file.  
  
 Args:  
 file\_path: Path to the text file containing the chat messages.  
  
 Returns:  
 A `ChatSession` object containing the loaded chat messages.  
 """  
 with open(file\_path, "r", encoding="utf-8") as file:  
 lines = file.readlines()  
  
 results: List[BaseMessage] = []  
 current\_sender = None  
 current\_timestamp = None  
 current\_content = []  
 for line in lines:  
 if re.match(self.\_message\_line\_regex, line):  
 if current\_sender and current\_content:  
 results = self.\_append\_message\_to\_results(  
 results, current\_sender, current\_timestamp, current\_content)  
 current\_sender, current\_timestamp = re.match(self.\_message\_line\_regex, line).groups()  
 current\_content = []  
 else:  
 current\_content.append(line.strip())  
  
 if current\_sender and current\_content:  
 results = self.\_append\_message\_to\_results(  
 results, current\_sender, current\_timestamp, current\_content)  
  
 return chat\_loaders.ChatSession(messages=results)  
  
 def lazy\_load(self) -> Iterator[chat\_loaders.ChatSession]:  
 """  
 Lazy load the messages from the chat file and yield them in the required format.  
  
 Yields:  
 A `ChatSession` object containing the loaded chat messages.  
 """  
 yield self.\_load\_single\_chat\_session\_from\_txt(self.path)  

```

2. Create loader[​](#2-create-loader "Direct link to 2. Create loader")

______________________________________________________________________

We will point to the file we just wrote to disk.

```python
loader = WeChatChatLoader(  
 path="./wechat\_chats.txt",  
)  

```

3. Load Messages[​](#3-load-messages "Direct link to 3. Load Messages")

______________________________________________________________________

Assuming the format is correct, the loader will convert the chats to langchain messages.

```python
from typing import List  
from langchain.chat\_loaders.base import ChatSession  
from langchain.chat\_loaders.utils import (  
 map\_ai\_messages,  
 merge\_chat\_runs,  
)  
  
raw\_messages = loader.lazy\_load()  
# Merge consecutive messages from the same sender into a single message  
merged\_messages = merge\_chat\_runs(raw\_messages)  
# Convert messages from "男朋友" to AI messages  
messages: List[ChatSession] = list(map\_ai\_messages(merged\_messages, sender="男朋友"))  

```

```python
messages  

```

```text
 [{'messages': [HumanMessage(content='天气有点凉', additional\_kwargs={'sender': '女朋友', 'events': [{'message\_time': '2023/09/16 2:51 PM'}]}, example=False),  
 AIMessage(content='珍簟凉风著，瑶琴寄恨生。嵇君懒书札，底物慰秋情。', additional\_kwargs={'sender': '男朋友', 'events': [{'message\_time': '2023/09/16 2:51 PM'}]}, example=False),  
 HumanMessage(content='忙什么呢', additional\_kwargs={'sender': '女朋友', 'events': [{'message\_time': '2023/09/16 3:06 PM'}]}, example=False),  
 AIMessage(content='今天只干成了一件像样的事\n那就是想你', additional\_kwargs={'sender': '男朋友', 'events': [{'message\_time': '2023/09/16 3:06 PM'}]}, example=False)]}]  

```

### Next Steps[​](#next-steps "Direct link to Next Steps")

You can then use these messages how you see fit, such as fine-tuning a model, few-shot example selection, or directly make predictions for the next message

```python
from langchain.chat\_models import ChatOpenAI  
  
llm = ChatOpenAI()  
  
for chunk in llm.stream(messages[0]['messages']):  
 print(chunk.content, end="", flush=True)  

```

- [1. Create message dump](#1-create-message-dump)

- [2. Define chat loader](#2-define-chat-loader)

- [2. Create loader](#2-create-loader)

- [3. Load Messages](#3-load-messages)

  - [Next Steps](#next-steps)

- [Next Steps](#next-steps)
